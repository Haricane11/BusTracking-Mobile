<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html,
    body,
    #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f0f0;
    }

    #location-btn {
      position: absolute;
      top: 40px;
      right: 16px;
      z-index: 20;
      width: 35px;
      height: 35px;
      background-color: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #location-btn:active {
      background-color: #f0f0f0;
    }

    #location-btn svg {
      width: 24px;
      height: 24px;
      fill: #4a5568;
    }

    /* ðŸ”µ Custom User Location Marker Style */
    .user-location-circle-marker {
      width: 16px;
      height: 16px;
      background-color: #4285F4;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.3);
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <button id="location-btn" title="Center Location">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <g data-name="48.Target">
        <path
          d="M12 24a12 12 0 1 1 12-12 12.013 12.013 0 0 1-12 12zm0-22a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2z" />
        <path d="M12 18a6 6 0 1 1 6-6 6.006 6.006 0 0 1-6 6zm0-10a4 4 0 1 0 4 4 4 4 0 0 0-4-4z" />
        <path d="M11 4h2v6h-2zM11 14h2v6h-2zM14 11h6v2h-6zM4 11h6v2H4z" />
      </g>
    </svg>
  </button>

  <script>
    let map = null;
    let markers = [];
    const SEARCH_RADIUS_KM = 0.7;
    const ROUTE_SOURCE_ID = 'bus-route-source';
    const ROUTE_LAYER_ID = 'bus-route-road-line';
    const PROFILE = 'driving';

    /* ðŸ”¹ Send logs back to React Native */
    function logToRN(msg) {
      if (window.ReactNativeWebView) {
        const payload = typeof msg === 'object' ? JSON.stringify(msg) : msg;
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'LOG', message: payload }));
      }
    }

    /* ðŸ”¹ Send messages back to React Native */
    function postToRN(type, data) {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: type, message: data }));
      }
    }

    /* ðŸ”¹ Initialize map only when we have a token */
    function initializeMap(token, callback) {
      if (map) return callback();

      mapboxgl.accessToken = token;
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [96.155, 16.8],
        zoom: 10,
      });

      map.on('load', callback);
    }

    function cleanupLayers() {
      markers.forEach(m => m.remove());
      markers = [];
      if (map.getLayer('search-circle-fill')) map.removeLayer('search-circle-fill');
      if (map.getSource('search-circle-source')) map.removeSource('search-circle-source');
      if (map.getLayer(ROUTE_LAYER_ID)) map.removeLayer(ROUTE_LAYER_ID);
      if (map.getSource(ROUTE_SOURCE_ID)) map.removeSource(ROUTE_SOURCE_ID);
    }

    async function fetchAndDrawRouteOnRoad(routeInfo) {
      if (!map || !routeInfo || routeInfo.length < 2) return;
      cleanupLayers();

      const waypoints = routeInfo.map(s => `${s.longitude},${s.latitude}`).join(';');
      const url = `https://api.mapbox.com/directions/v5/mapbox/${PROFILE}/${waypoints}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        if (!json.routes || !json.routes.length) return;

        map.addSource(ROUTE_SOURCE_ID, { type: 'geojson', data: { type: 'Feature', geometry: json.routes[0].geometry } });
        map.addLayer({
          id: ROUTE_LAYER_ID, type: 'line', source: ROUTE_SOURCE_ID,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#0070f3', 'line-width': 7, 'line-opacity': 0.8 }
        });

        // Add Route Markers
        routeInfo.forEach((stop, index) => {
          const isTerminus = index === 0 || index === routeInfo.length - 1;
          const color = isTerminus ? '#e63946' : '#007cbf';
          const m = new mapboxgl.Marker({ color: color, scale: (isTerminus ? 0.8 : 0.7) })
            .setLngLat([stop.longitude, stop.latitude])
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
              <div style="padding: 5px; font-family: sans-serif;">
                <h5 style="margin:0;">${stop.name_en}</h5>
                <h5 style="margin:0; color:${color};">${stop.name_mm}</h5>
              </div>`))
            .addTo(map);
          markers.push(m);
        });

        const bbox = turf.bbox(json.routes[0].geometry);
        map.fitBounds(bbox, { padding: 100, maxZoom: 14 });
      } catch (e) { logToRN(`Route Error: ${e.message}`); }
    }

    function handleData(data) {
      if (!map) return;
      cleanupLayers();

      const { busStops, currentLocation, specificBusStop, routeInfo } = data;

      // 1. ROUTE MODE
      if (routeInfo && routeInfo.length > 0) {
        fetchAndDrawRouteOnRoad(routeInfo);
        return;
      }

      // 2. SPECIFIC STOP MODE
      if (specificBusStop) {
        const coords = [specificBusStop.longitude, specificBusStop.latitude];
        const m = new mapboxgl.Marker({ color: '#007cbf' }).setLngLat(coords).addTo(map);
        markers.push(m);
        map.flyTo({ center: coords, zoom: 15 });
        return;
      }

      // 3. NEARBY MODE
      const lng = currentLocation?.longitude || currentLocation?.coords?.longitude;
      const lat = currentLocation?.latitude || currentLocation?.coords?.latitude;
      if (!lng || !lat) return;
      const userCoords = [lng, lat];

      // Custom User Marker
      const userCircleEl = document.createElement('div');
      userCircleEl.className = 'user-location-circle-marker';
      const userMarker = new mapboxgl.Marker({ element: userCircleEl }).setLngLat(userCoords).addTo(map);
      markers.push(userMarker);

      // Search Radius Circle
      const circle = turf.circle(turf.point(userCoords), SEARCH_RADIUS_KM, { steps: 64, units: 'kilometers' });
      map.addSource('search-circle-source', { type: 'geojson', data: circle });
      map.addLayer({ id: 'search-circle-fill', type: 'fill', source: 'search-circle-source', paint: { 'fill-color': '#007cbf', 'fill-opacity': 0.15 } });

      // RESTORED: Filter nearby stops and send JSON back to RN
      busStops?.forEach(stop => {
        const stopCoords = [stop.longitude, stop.latitude];
        if (turf.booleanPointInPolygon(turf.point(stopCoords), circle)) {
          logToRN(JSON.stringify(stop)); // Sends back to React Native list
          const m = new mapboxgl.Marker({ color: '#00cc66', scale: 0.7 })
            .setLngLat(stopCoords)
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
              <div style="padding: 5px; font-family: sans-serif;">
                <h5 style="margin:0;">Bus Stop: ${stop.name_en}</h5>
                <h5 style="margin:0; color:#00cc66;">${stop.name_mm}</h5>
              </div>`))
            .addTo(map);
          markers.push(m);
        }
      });
      map.flyTo({ center: userCoords, zoom: 14 });
      
      document.getElementById('location-btn').addEventListener('click', () => {
        postToRN('REQUEST_LOCATION', { manual: true });
        map.flyTo({ center: userCoords, zoom: 14 });
      });
    }

    function onMessage(event) {
      try {
        const data = JSON.parse(event.data);
        const token = data.mapboxToken || window.MAPBOX_ACCESS_TOKEN;
        if (token) {
          initializeMap(token, () => handleData(data));
        } else {
          logToRN("Error: No Mapbox Token provided.");
        }
      } catch (e) { logToRN(`Parse Error: ${e.message}`); }
    }

    window.addEventListener('message', onMessage);
    document.addEventListener('message', onMessage);


  </script>
</body>

</html>